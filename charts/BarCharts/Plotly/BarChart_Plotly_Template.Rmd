---
title: "Plotly BarChart Template"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview of Template

This template demonstrates how to create an interactive bar chart with the Plotly library for a dataset structured as follows:

```{r example_df}
example_df <- data.frame(
  "Measure" = 1:3,
  "Category 1" = c("A","B","A"),
  "Category 2" = c("X","Y","Y")
)
knitr::kable(example_df)
```

Where the "measure" column contains numerical data which is categorised by a number of categories (or *dimensions*). There are therefore two interesting bar charts that can be generated:

- The mean value of the measure broken down by a particular category (Mean Parameter per Category)
- The number of observations broken down by a particular category (Number of Observations per Category)

Note that this template covers both how to build such a bar chart inside of an HTML RMarkdown file and how to functionalise the code so as to conveniently switch between different categories and metrics in a Shiny app.

## Import and Clean Data

The data for this template is a .csv file accessed from Figshare [here](https://figshare.com/articles/Investigation_into_the_number_of_desktop_items_on_University_staff_computers_broken_down_by_department_and_operating_system_/3425729) using `read.csv`.

```{r import_data}
desktopItems <- read.csv(file = "https://ndownloader.figshare.com/files/5360960")
knitr::kable(head(desktopItems))
```

An advanced version of this template might attempt to automatically infer the measure and appropriate categories for the data, in this template we explicitly decide which columns are categories (or dimensions) and which column is the measure:

```{r define_columns}
measure_column <- "Desktop.Items"
categories <- c("Operating.System","University.Department","University","Country")
```

These columns will be used in the BarCharts to decide what dimensions of the data we are visualising.

## Mean Parameter per Category

Using the `aggregate` function the mean number of desktop items per category can easily be calculated, the chosen category for aggregation will be assigned to `selected_dimension`. The function `as.name` is necessary to convert strings into valid column names.

```{r mean_aggregate}
selected_dimension <- categories[1]
aggregate_mean <- aggregate(data = desktopItems, eval(as.name(measure_column)) ~ eval(as.name(selected_dimension)), FUN = mean)
aggregate_mean
```

For convenience in the visualisation, the column names of the `data.frame` are renamed:

```{r mean_rename}
colnames(aggregate_mean) <- c(selected_dimension, measure_column)
```

The `data.frame` can now be visualised using `Plotly` as follows, note that `eval` is necessary as the `x` and `y` arguments are assumed to be explicit column names for the `data` provided to `plotly` - `eval` forces the evaluation of `as.name(selected_dimension)`.

```{r}
library(plotly)
library(plotly)
plot_ly(data = aggregate_mean,
        type = "bar",
        x = eval(as.name(selected_dimension)),
        y = eval(as.name(measure_column))) %>%
  layout(xaxis = list(title = selected_dimension),
         yaxis = list(title = "Mean Number of Desktop Items"),
         title = paste0("Mean number of desktop items aggregated by ",selected_dimension))
```

The column names for the categories are formatted with periods instead of spaces, i.e. Operating.System which does not aid comprehension of the chart. Using `gsub` a utility function called `format_label` is created to replace the periods:

```{r}
format_label <- function(dimension){
  gsub(pattern = "[.]", replacement = " ", x = dimension)
}
plot_ly(data = aggregate_mean,
        type = "bar",
        x = eval(as.name(selected_dimension)),
        y = eval(as.name(measure_column))) %>%
  layout(xaxis = list(title = format_label(selected_dimension)),
         yaxis = list(title = "Mean Number of Desktop Items"),
         title = paste0("Mean number of desktop items aggregated by ",format_label(selected_dimension)))
```


Often dimensions have long labels, which are best suited to horizontally orientated bar charts - noting that some other charting tools refer to vertical bar charts as "column charts". Independent of orientation, bar charts are more legible if bars are ordered from largest to smallest, as show below. Note that the left margin of the visualisation has also been extended for legibility purposes.

```{r}
aggregate_mean <- aggregate_mean[order(aggregate_mean$Desktop.Items),]
plot_ly(data = aggregate_mean,
        type = "bar",
        y = eval(as.name(selected_dimension)),
        x = eval(as.name(measure_column)),
        orientation = "h") %>%
  layout(xaxis = list(title = "Mean Number of Desktop Items"),
         yaxis = list(title = format_label(selected_dimension)),
         title = paste0("Mean number of desktop items aggregated by ",format_label(selected_dimension)),
         margin = list(l = 80))
```

## Number of Observations per Category

The number of observations per category can be calculated with `aggregate` by applying the `FUN` length across the subset data - i.e. how long is the list of observations for each category. 

```{r noObservations_aggregate}
aggregate_number_of_observations <- aggregate(data = desktopItems, eval(as.name(measure_column)) ~ eval(as.name(selected_dimension)), FUN = length)
colnames(aggregate_number_of_observations) <- c(selected_dimension,"Desktop.Items")
```

Using the same code as above, a barchart of the aggregated data can easily be generated:

```{r}
aggregate_number_of_observations <- aggregate_number_of_observations[order(aggregate_number_of_observations$Desktop.Items),]
plot_ly(data = aggregate_number_of_observations,
        type = "bar",
        y = eval(as.name(selected_dimension)),
        x = eval(as.name(measure_column)),
        orientation = "h") %>%
  layout(xaxis = list(title = "Number of respondants"),
         yaxis = list(title= format_label(selected_dimension)),
         title = paste0("Number of respondants aggregated by ",format_label(selected_dimension)),
         margin = list(l = 80))
```

## Functionalising 

The steps above can be functionalised relatively easily, it is adviseable to split the code into two steps: aggregation and visualisation:

```{r}
aggregate_data_for_barchart <-
  function(data = NA,
           dimension_column = NA,
           measure_column = NA,
           aggregate_function = NA) {
    aggregated_data <-
      aggregate(data = data,
                eval(as.name(measure_column)) ~ eval(as.name(dimension_column)),
                FUN = aggregate_function)
    colnames(aggregated_data) <- c(dimension_column, measure_column)
    
    aggregated_data <-
      aggregated_data[order(aggregated_data[, measure_column]), ]
    # Return for use
    aggregated_data
  }
```

This function can easily be called to aggregate the data as follows:

```{r}
intermediate_aggregate <- aggregate_data_for_barchart(
  data = desktopItems,
  dimension_column = "University",
  measure_column = "Desktop.Items",
  aggregate_function = mean
)
knitr::kable(intermediate_aggregate)
```

The function below is used to generate a plotly bar chart from the aggregate data function, note that a number of additional arguments have been added to provide greater flexibility over the output.

```{r}
plotly_aggregated_barchart <- function(
  data = NA,
  dimension_column = NA,
  measure_column = NA,
  aggregate_description = NA,
  left_margin = 100,
  displayFurniture = T
) {
  plot_ly(
    data = data,
    type = "bar",
    y = eval(as.name(dimension_column)),
    x = Desktop.Items,
    orientation = "h"
  ) %>%
    layout(
      xaxis = list(title = "Number of respondants"),
      yaxis = list(title = ""),
      title = paste0(
        aggregate_description," aggregated by ",
        format_label(dimension_column)
      ),
      margin = list(l = left_margin)
    ) %>%
    config(displayModeBar = displayFurniture)
}
```

For example:

```{r}
plotly_aggregated_barchart(
  data = intermediate_aggregate,
  dimension_column = "University",
  measure_column = "Desktop.Items",
  aggregate_description = "Mean number of desktop items",
  displayFurniture = F
)

```


